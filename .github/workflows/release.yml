name: Date-Based Release

on:
  push:
    branches:
      - main

permissions:
  contents: write # Required to push tags

jobs:
  date-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-go@v6
        with:
          go-version: '1.25.5'

      - name: Install Build Dependencies
        run: |
          sudo add-apt-repository ppa:ubuntuhandbook1/ffmpeg7 -y
          sudo apt-get update
          sudo apt-get install -y gcc pkg-config libavcodec-dev libavdevice-dev libavfilter-dev libavformat-dev libswresample-dev libswscale-dev libavutil-dev libpostproc-dev

      # 1. Run Tests
      - name: Run Tests
        run: go test -v ./...

      # 2. Generate Tag and Push
      - name: Create Date Tag
        id: tag
        run: |
          VERSION="v1.1.0-$(date -u +%Y%m%d%H%M%S)-${GITHUB_SHA::12}"
          
          echo "Creating tag: $VERSION"
          
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git tag $VERSION
          git push origin $VERSION
          
          echo "tag_name=$VERSION" >> $GITHUB_OUTPUT

      # 3. Refresh Proxy
      - name: Refresh pkg.go.dev
        continue-on-error: true
        env:
          GOPROXY: https://proxy.golang.org
        run: |
          go list -m github.com/leeineian/minder@${{ steps.tag.outputs.tag_name }}